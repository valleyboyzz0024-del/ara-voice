<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice to Sheets</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #f0f2f5; margin: 0; text-align: center; }
        #recordButton { width: 100px; height: 100px; border-radius: 50%; border: none; background: #007aff; color: white; font-size: 1.2em; cursor: pointer; transition: background-color 0.2s; }
        #recordButton.recording { background: #dc3545; }
        #status { margin-top: 20px; font-size: 1.2em; color: #333; height: 50px; }
    </style>
</head>
<body>
    <h1>Voice Controller</h1>
    <button id="recordButton">Record</button>
    <p id="status">Tap the button and speak your command.</p>

    <script>
        console.log("Page script loaded.");

        const recordButton = document.getElementById('recordButton');
        const statusDiv = document.getElementById('status');
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (SpeechRecognition) {
            console.log("SpeechRecognition API is available.");
            const recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.lang = 'en-US';

            recordButton.addEventListener('click', () => {
                console.log("Record button clicked.");
                if (recordButton.classList.contains('recording')) {
                    recognition.stop();
                    recordButton.classList.remove('recording');
                } else {
                    statusDiv.textContent = 'Listening...';
                    recordButton.classList.add('recording');
                    recognition.start();
                }
            });

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                console.log("Speech recognized:", transcript);
                statusDiv.textContent = `Processing: "${transcript}"`;
                sendCommand(transcript);
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                statusDiv.textContent = `Error: ${event.error}. Please try again.`;
                recordButton.classList.remove('recording');

            };
            
            recognition.onend = () => {
                console.log("Recognition ended.");
                recordButton.classList.remove('recording');
            };

        } else {
            console.error("SpeechRecognition API is not supported in this browser.");
            statusDiv.textContent = "Sorry, your browser doesn't support Speech Recognition.";
            recordButton.disabled = true;
        }

        async function sendCommand(commandText) {
            console.log("Sending command to server:", commandText);
            statusDiv.textContent = 'Sending...';
            try {
                const response = await fetch('/process-command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: commandText })
                });

                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }

                const result = await response.json();
                console.log("Received response from server:", result);
                
                if (result.status === 'success') {
                    statusDiv.textContent = `Success!`;
                } else {
                    statusDiv.textContent = `Error: ${result.message}`;
                }
            } catch (error) {
                console.error("Failed to send command:", error);
                statusDiv.textContent = `Failed to send command. Check console.`;
            }
        }
    </script>
</body>
</html>